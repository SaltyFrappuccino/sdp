import React, { useState } from 'react';
import {
  Panel,
  PanelHeader,
  Group,
  Card,
  CardGrid,
  Header,
  Text,
  Button,
  Search,
  PanelHeaderBack
} from '@vkontakte/vkui';
import { Icon24Info, Icon24Users, Icon24Fire, Icon24ChevronRight } from '@vkontakte/icons';
import { useRouteNavigator } from '@vkontakte/vk-mini-apps-router';

interface HandbookProps {
  id: string;
}

export const Handbook: React.FC<HandbookProps> = ({ id }) => {
  const routeNavigator = useRouteNavigator();
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedSection, setSelectedSection] = useState<string | null>(null);

  const sections = [
    // ОСНОВЫ МИРА
    {
      id: 'world',
      title: 'Мир и Лор',
      icon: <Icon24Info />,
      color: '#4CAF50',
      category: 'Основы мира',
      priority: 1,
      content: {
        title: 'Мир после Разлома',
        description: 'В 1800 году произошел Разлом - невидимый катаклизм, который истончил барьер между миром людей и параллельным измерением, где обитают Существа.',
        keyPoints: [
          '224 года перемен: Путь к настоящему',
          'Появление Проводников и их Контрактов с Существами',
          'Технологический прогресс, подстегиваемый постоянными конфликтами',
          'Новый миропорядок: шесть крупных островов-государств',
          'Три могущественные фракции: Отражённый Свет Солнца, Чёрная Лилия, Порядок'
        ],
        detailedContent: `
### 1800 год: Разлом

История мира, каким мы его знаем, началась в 1800 году. До этого момента человечество жило в привычной реальности, ограниченной законами физики. Но в один день по всему миру произошел Разлом — невидимый катаклизм, который истончил барьер между миром людей и параллельным измерением, где обитают Существа.

Эти сущности, воплощения идей, мифов и концепций, хлынули в наш мир. Для подавляющего большинства людей они остались невидимы и неслышимы, но их присутствие начало искажать реальность, порождая аномальные зоны и необъяснимые явления. Одновременно с этим по всей планете начали рождаться дети с уникальным даром — способностью видеть и взаимодействовать с этими сущностями. Их назвали Проводниками.

### 224 года перемен: Путь к настоящему

Последующие два столетия стали эпохой хаоса, открытий и войн. Человечество, столкнувшись с новой, непонятной силой, пыталось ее изучить, подчинить или уничтожить. Появление Проводников и их Контрактов с Существами навсегда изменило баланс сил. Войны велись не только армиями, но и одиночками, способными обрушивать на врага огонь и проклятия.

Технологический прогресс, подстегиваемый постоянными конфликтами и необходимостью противостоять сверхъестественным угрозам, совершил невероятный скачок. Кибернетика, робототехника, медицина и энергетика развивались семимильными шагами. Старые нации и государства рухнули под натиском новой реальности. На их руинах возник новый миропорядок, центром которого стали шесть крупных островов-государств, а главной движущей силой — три могущественные фракции, ведущие вечную борьбу за влияние.
        `
      }
    },
    {
      id: 'conductors',
      title: 'Проводники',
      icon: <Icon24Users />,
      color: '#2196F3',
      category: 'Основы мира',
      priority: 2,
      content: {
        title: 'Проводники - Связующее Звено',
        description: 'Особенные люди, обладающие даром видеть Существ и взаимодействовать с ними. Только они могут заключать контракты с Существами.',
        keyPoints: [
          'Ранги: F → E → D → C → B → A → S → SS → SSS',
          'Количество контрактов зависит от ранга',
          'F-E-D: 1 контракт',
          'C-B: до 3 контрактов',
          'A: до 5 контрактов',
          'S: до 7 контрактов',
          'SS: до 9 контрактов',
          'SSS: до 11 контрактов'
        ]
      }
    },
    {
      id: 'creatures',
      title: 'Существа',
      icon: <Icon24Fire />,
      color: '#FF9800',
      category: 'Основы мира',
      priority: 3,
      content: {
        title: 'Существа - Мистические Создания',
        description: 'Потусторонние создания, существующие параллельно с нашим миром и недоступные взору обычных людей.',
        keyPoints: [
          'Ранги: F до SSS (постоянные, не изменяются)',
          'Каждое Существо обладает спектром (тематика способностей)',
          'Максимальный регистрируемый ранг: A',
          'Ранги выше A требуют согласования с ГА',
          'Активный контракт только с одним Проводником'
        ]
      }
    },
    {
      id: 'contracts',
      title: 'Контракты',
      icon: <Icon24Users />,
      color: '#9C27B0',
      category: 'Основы мира',
      priority: 4,
      content: {
        title: 'Магические Договоры',
        description: 'Договор между Проводником и Существом, подробно описывающий условия использования способностей.',
        keyPoints: [
          'Идентификация Существа',
          'Перечень способностей и их ограничения',
          'Откаты и время восстановления',
          'Условия использования',
          'Стоимость в ДЭ (если есть)',
          'Изменения внешнего облика',
          'Может быть расторгнут по обоюдному согласию'
        ]
      }
    },
    {
      id: 'factions',
      title: 'Фракции',
      icon: <Icon24Fire />,
      color: '#F44336',
      category: 'Политика и власть',
      priority: 1,
      content: {
        title: 'Три Могущественные Фракции',
        description: 'Ведут вечную борьбу за влияние в мире после Разлома.',
        keyPoints: [
          'Отражённый Свет Солнца: Религиозная фракция, видит Проводников как высшую форму существования',
          'Чёрная Лилия: Мафиозная структура, не ограниченная моральными нормами',
          'Порядок: Официальное представительство власти среди Проводников'
        ],
        detailedContent: `
### Отражённый Свет Солнца

Отражённый Свет Солнца – это религиозная фракция, которая видит Проводников как высшую форму существования и новый шаг в эволюции человечества. В отличие от традиционных представлений о религиозных орденах, члены этой фракции ведут современный образ жизни, интегрируясь в общество и занимаясь обычной деятельностью.

#### Высшее Руководство
- **Арбитр**: Абсолютный лидер фракции, живое воплощение ее идеалов. Считается самым близким к "божественному свету" Проводником.
- **Гелиос**: Заместитель и правая рука Патриарха. Управляет фракцией в его отсутствие и отвечает за оба крыла организации.
- **Сэнтинел**: Страж и защитник всего ОСС, но, самое главное - постоянный защитник Арбитра и Гелиоса.

#### Духовное Крыло (Совет Светил)
- **Оракул**: Член высшего духовного совета. Каждый Оракул курирует одно из направлений деятельности ОСС (экономика, образование, безопасность и т.д.).
- **Трибун**: Глава крупного храма или монастыря. Отвечает за духовное воспитание Проводников на своей территории.
- **Адепт**: Рядовой священнослужитель или идеолог, работающий в храмах и образовательных центрах.

#### Исполнительное Крыло (Совет Констелларов)
- **Зодиак**: Командир одного из двенадцати подразделений. Это могущественные Проводники высшего ранга, прошедшие суровый отбор.
- **Спектр**: Заместитель и правая рука Зодиака, его самый доверенный человек.
- **Нова**: Рядовой член одного из 12-ти отрядов Зодиака.
- **Паладин**: Не ранг, а высший почётный титул. Присваивается самым выдающимся воинам в истории ОСС.

### Чёрная Лилия

Чёрная Лилия – это могущественная мафиозная структура, не ограниченная моральными нормами или правилами, принятыми другими фракциями. Они видят мир как поле битвы за власть, где только сильнейший может удержаться на вершине.

#### Купол (Верхушка Семьи)
- **Дон / Мадонна**: Глава Семьи, "отец" или "мать" для всех ее членов. Его слово — абсолютный закон.
- **Консильери**: Главный советник Дона. Не отдает приказов, но его мнение имеет огромный вес.
- **Младший Босс**: Заместитель Дона и его официальный наследник. Командует Капо и передает им волю главы.

#### Боевая Группа
- **Капо**: "Глава команды". Влиятельный член Семьи, который руководит собственным отрядом (бригадой) и контролирует определенную территорию.
- **Солдат**: Полноправный, "посвященный" член Семьи, который принес клятву верности.
- **Соучастник**: Человек, который работает на Семью, но не является ее полноправным членом.

#### Элитные Специализированные Отряды
- **Клинки Лилии**: Международные убийства. Главный наступательный актив Семьи.
- **Ночные Клинки**: Личная гвардия Дона. Абсолютная элита, чья верность и мастерство не вызывают сомнений.
- **Фантомы**: Внутренняя безопасность и контрразведка. Тайная полиция Чёрной Лилии.
- **Корсары**: Логистика и контрабанда. Кровеносная система Семьи.
- **Жнецы**: Охрана высшего командования. Высококвалифицированные телохранители.

### Порядок

Порядок – это официальное представительство власти среди Проводников. Фракция была основана как инструмент для обеспечения мира и соблюдения законности в мире, где магические способности и Контракты могут стать оружием массового поражения.

#### Основной Состав
- **Верховный Судья**: Глава Порядка. Он не только командующий, но и высшая судебная инстанция для всех Проводников.
- **Совет Триумвирата**: Три Заместителя, каждый из которых возглавляет один из Департаментов.

#### Департамент Исполнения (Молот Закона)
- **Глава Офицеров**: Следующий после Заместителя Главы человек. Командует всеми офицерами.
- **Высший Офицер**: Офицеры, занимающие особенно плотную позицию во Фракции, не всегда благодаря своим навыкам. Как правило, это Проводник Ранга A и выше.
- **Старший Офицер**: Офицер высокого ранга с большими боевыми способностями. Как правило это Проводник ранга B и выше.
- **Офицер**: Нововступивший в отряд Офицер. Как правило это Проводник ранга C и ниже.

#### Департамент Расследований (Лик Закона)
- **Инквизитор**: Старший следователь, которому поручают самые сложные и резонансные дела.
- **Детектив**: Следователь, занимающийся рутинными расследованиями, допросами и сбором улик.
- **Аналитик**: Сотрудник, работающий с базами данных, прослушкой и системами наблюдения.

#### Департамент Надзора (Всевидящее Око)
- **Куратор**: Офицер, ответственный за надзор над определенным регионом или группой Проводников.
- **Регистратор**: Агент, который ведет учет Проводников, их Контрактов и инцидентов.
- **Наблюдатель**: Агент "в поле", который тайно или явно следит за деятельностью зарегистрированных Проводников.
        `
      }
    },
    {
      id: 'islands',
      title: 'Острова',
      icon: <Icon24Info />,
      color: '#00BCD4',
      category: 'Политика и власть',
      priority: 2,
      content: {
        title: 'Шесть Островов-Государств',
        description: 'Центр нового миропорядка после падения старых наций.',
        keyPoints: [
          'Кага: Глобальная столица, воплощение прогресса и порядка',
          'Хоши: Духовный центр, доминирует Отражённый Свет Солнца',
          'Ичи: Воплощение неудержимого капитализма',
          'Куро: Контролируется Чёрной Лилией',
          'Мидзу: Первозданный мир, управляется Советом Кланов',
          'Сора: Дипломатическая столица, нейтральная территория'
        ]
      }
    },
    {
      id: 'attributes',
      title: 'Атрибуты',
      icon: <Icon24Users />,
      color: '#FF5722',
      category: 'Боевая система',
      priority: 1,
      content: {
        title: 'Влияние Атрибутов на Бой',
        description: 'Ваши Атрибуты — это основа, на которую накладываются сверхъестественные способности. Они определяют, как ваш персонаж действует в те моменты, когда Аура не используется.',
        keyPoints: [
          'Сила: Урон от холодного и рукопашного оружия, захваты и броски',
          'Реакция и Ловкость: Ключевые атрибуты для уклонения',
          'Выносливость: Способность продолжать бой после полученного урона',
          'Меткость: Успешность при использовании дальнобойного оружия',
          'Холодное Оружие и Рукопашный Бой: Преимущество в ближнем бою',
          'Восприятие: Замечать подготовку к атаке, видеть слабые места',
          'Скрытность: Возможность начать бой на ваших условиях'
        ],
        detailedContent: `
### Влияние Атрибутов на Бой

**Сила**: Влияет на урон от холодного и рукопашного оружия, а также на способность к захватам и броскам. Персонаж с высокой Силой может проломить слабое укрытие или отбросить противника.

**Реакция и Ловкость**: Ключевые атрибуты для уклонения. Против простых физических атак (удар мечом, летящий кирпич) или медленных способностей (с низким рангом тега [Неотвратимый]), вы можете использовать свою Ловкость, чтобы увернуться, не тратя Ячейку Ауры.

**Выносливость**: Определяет вашу способность продолжать бой после полученного урона. Персонаж с высокой Выносливостью может проигнорировать болевой шок и продолжить действовать, в то время как другой будет дезориентирован.

**Меткость**: Напрямую влияет на вашу успешность при использовании дальнобойного оружия. Мастер-снайпер может попасть в уязвимое место, даже если цель частично скрыта за укрытием.

**Холодное Оружие и Рукопашный Бой**: Дают преимущество в ближнем бою. Персонаж-Мастер может парировать атаки, которые Новичок был бы вынужден блокировать телом или щитом.

**Восприятие**: Позволяет замечать подготовку к атаке, видеть слабые места в защите противника или распознавать иллюзии.

**Скрытность**: Дает возможность начать бой на ваших условиях, нанеся удар первым из тени.
        `
      }
    },
    {
      id: 'tags',
      title: 'Теги и Ранги',
      icon: <Icon24Fire />,
      color: '#9C27B0',
      category: 'Боевая система',
      priority: 2,
      content: {
        title: 'Система Тегов',
        description: 'Каждая способность создается из Тегов в рамках «Бюджета Мощи». Стоимость растет экспоненциально, отражая огромную разницу в силе между рангами.',
        keyPoints: [
          'Ранги тегов: F, E, D, C, B, A, S, SS, SSS',
          'Стоимость: F=1, E=2, D=5, C=10, B=20, A=35, S=70, SS=100, SSS=150',
          'Типы тегов: Пробивающий, Неотвратимый, Область, Контроль, Защитный, Концептуальный',
          'Бюджет по ячейкам: Нулевые=5, Малые=20, Значительные=50, Предельные=150'
        ],
        detailedContent: `
### Стоимость Тегов

| Ранг Тега | Стоимость в Очках |
|-----------|-------------------|
| F         | 1                 |
| E         | 2                 |
| D         | 5                 |
| C         | 10                |
| B         | 20                |
| A         | 35                |
| S         | 70                |
| SS        | 100               |
| SSS       | 150               |

### Бюджет и Ограничения по типу Ячейки:

**Нулевые Ячейки:**
- Бюджет Мощи: 5 очков
- Максимальный Ранг Тега: F

**Малые Ячейки (I):**
- Бюджет Мощи: 20 очков
- Максимальный Ранг Тега: C

**Значительные Ячейки (II):**
- Бюджет Мощи: 50 очков
- Максимальный Ранг Тега: A

**Предельные Ячейки (III):**
- Бюджет Мощи: 150 очков
- Максимальный Ранг Тега: SSS

### Детальное Описание Тегов по Рангам

#### [Пробивающий] (Разрушительная мощь)
- **F**: Пробивает толстое стекло, оставляет глубокие царапины на камне.
- **E**: Ломает деревянную мебель, пробивает тонкий листовой металл.
- **D**: Пробивает кирпичную кладку, гнет стальные прутья.
- **C**: Пробивает стену из шлакоблоков, оставляет вмятины на броне.
- **B**: Пробивает железобетонную стену или легкую броню БТР.
- **A**: Пробивает дверь банковского сейфа или основную броню танка.
- **S**: Способен вызвать обрушение небоскреба одной сфокусированной атакой.
- **SS**: Испаряет небольшое озеро, оставляет глубокий кратер в земле.
- **SSS**: Способен расколоть небольшую гору или вызвать тектонический сдвиг.

#### [Неотвратимый] (Скорость и сложность уклонения)
- **F**: Скорость брошенного камня. Легко увернуться.
- **E**: Скорость стрелы из спортивного лука. Требует хорошей реакции.
- **D**: Скорость пули из пистолета. Уклонение требует [Реакции (Опытный)].
- **C**: Скорость пули из штурмовой винтовки. Уклонение требует [Реакции (Мастер)] или способностей.
- **B**: Околозвуковая скорость. Уклонение невозможно без сверхъестественных способностей.
- **A**: Звуковая скорость (Мах). Уклонение требует равных по рангу способностей предвидения или защитных техник.
- **S**: Сверхзвуковая скорость (5 Махов) или мгновенное перемещение в пределах видимости.
- **SS**: Атака происходит концептуально (например, "пространство само сжимается вокруг цели").
- **SSS**: Атака происходит вне концепции времени, поражая цель в прошлом, настоящем и будущем одновременно.

#### [Область] (Радиус действия)
- **F**: Небольшая комната (3х3 метра).
- **E**: Просторная комната (10х10 метров).
- **D**: Большой зал или узкая улица.
- **C**: Небольшая городская площадь.
- **B**: Футбольное поле или несколько этажей небоскреба.
- **A**: Целый городской квартал.
- **S**: Несколько городских кварталов, например, весь район "Неон-Сити".
- **SS**: Небольшой остров, например, Мидзу.
- **SSS**: Целый континент.

#### [Контроль] (Ограничение противника)
- **F**: Легкое головокружение, помехи в радио.
- **E**: Секундная дезориентация, создание скользкой поверхности.
- **D**: Временное ослепление или оглушение, внушение легкого беспокойства.
- **C**: Внушение сильного страха, создание простых иллюзий (например, стена).
- **B**: Временный паралич одной конечности, создание реалистичных иллюзорных копий.
- **A**: Полный временный паралич тела, создание сложных иллюзий, неотличимых от реальности.
- **S**: Манипуляция памятью (стирание или изменение одного воспоминания), полный контроль над волей цели на короткое время.
- **SS**: Массовая манипуляция памятью или эмоциями (сотни людей).
- **SSS**: Переписывание личности человека или целой группы людей.

#### [Защитный] (Прочность и свойства защиты)
- **F**: Блокирует удар ножом или битой.
- **E**: Блокирует пули из пистолета.
- **D**: Выдерживает очередь из пистолета-пулемета.
- **C**: Выдерживает очередь из штурмовой винтовки.
- **B**: Выдерживает взрыв гранаты или выстрел из крупнокалиберной винтовки.
- **A**: Способен выдержать прямой выстрел из танкового орудия.
- **S**: Способен пережить тактический ядерный взрыв в эпицентре.
- **SS**: Может выдержать падение метеорита.
- **SSS**: Абсолютная защита от любого физического урона.

#### [Концептуальный] (Нечестные штуки)
- **F**: Узнать погоду на завтра, заставить растение быстрее расти.
- **E**: Узнать, лжет ли человек по одному вопросу.
- **D**: Создать оружие, которое наносит урон только живой плоти или чему-то более духовному.
- **C**: Способность видеть сквозь стены на небольшом расстоянии.
- **B**: Атака, которая игнорирует физическую броню и бьет напрямую по телу.
- **A**: Раны от этой способности нельзя исцелить обычными или магическими средствами низкого ранга.
- **S**: "Атака, которая всегда попадает в цель, игнорируя любые препятствия".
- **SS**: "Удар, стирающий цель из памяти всех, кто ее знал".
- **SSS**: "Проклятие, меняющее судьбу человека или целого рода".
        `
      }
    },
    {
      id: 'combat',
      title: 'Боевая Система',
      icon: <Icon24Fire />,
      color: '#E91E63',
      category: 'Боевая система',
      priority: 3,
      content: {
        title: 'Фундамент Боя',
        description: 'Система, основанная на атрибутах, рангах и ячейках Ауры.',
        keyPoints: [
          'Атрибуты влияют на бой: Сила, Реакция, Ловкость, Выносливость, Меткость',
          'Ячейки Ауры: Нулевые, Малые (I), Значительные (II), Предельные (III)',
          'Принцип Доминирования Рангов: Высший ранг побеждает низший',
          'Бюджет Мощи для создания способностей',
          'Правило Трёх Исключений для победы над сильнейшим'
        ],
        detailedContent: `
### Принцип Доминирования Рангов

Это базовый закон мира, определяющий исход столкновения способностей. Способность, имеющая Тег более высокого ранга, побеждает способность с Тегом более низкого ранга.

- **Атака (Тег B) > Защиты (Тег C)**: Атака пробивает защиту, но ее эффект ослабляется. Щит ранга С не остановит огненный шар ранга В, но уменьшит его урон с критического до серьезного.
- **Атака (Тег B) = Защите (Тег B)**: Способности нейтрализуют друг друга. Огненный шар и водяной барьер одного ранга, скорее всего, испарятся в облаке пара.
- **Атака (Тег C) < Защиты (Тег B)**: Атака полностью или почти полностью блокируется.

### Правило Трёх Исключений: Как Победить Сильнейшего

#### 1. Аспектное Преимущество
Это фундаментальный закон "камень-ножницы-бумага". Если ваша способность является прямой контрмерой для атаки противника, она может победить даже при разнице в рангах.

**Пример**: Атака [Пробивающий (B)] в виде Огненного Копья летит в вас. Ваш "Водяной Щит" с тегом [Защитный (C)] должен быть пробит. Но так как вода является прямой контрой огню, ваш щит выдерживает, полностью испаряясь. Вы не получаете урона.

#### 2. Перегрузка
Вы можете вложить в свою способность больше сил, чем обычно, чтобы превзойти противника.

**Пример**: Чтобы заблокировать то же "Огненное Копье" [Пробивающий (B)], вы можете использовать два барьера с тегом [Защитный (C)] одновременно. Для этого вы тратите две Малые Ячейки вместо одной (если бюджет позволяет). Ваша защита выдерживает, но цена за это — двойной расход ресурсов.

#### 3. Командная Работа
Совместные усилия могут превзойти индивидуальную мощь.

**Пример**: Один Проводник создает стену с тегом [Защитный (C)], а второй накладывает на нее усиление с тегом [Защитный (C)]. Суммарно их защита может рассматриваться как эквивалент ранга B и заблокировать соответствующую атаку.

### Принцип Убывающей Прочности

Даже самая прочная защита не является абсолютной. Ее можно сломить не только одной мощной атакой, но и серией более слабых.

**Как это работает**: Если защитный объект (например, барьер с тегом [Защитный (B)]) получает урон от более слабой атаки (например, с тегом [Пробивающий (C)]), он не разрушается мгновенно, но его прочность снижается.

**Отыгрыш**: В своем посте вы должны описать, как на защите появляются трещины, сколы, как она тускнеет или деформируется. После нескольких таких атак (обычно 2, если разница в 1 Ранг) защита разрушается. Это делает возможным пробитие сильной обороны даже для более слабых, но настойчивых противников.

### Правило Клетки: Бой до Конца

Вы не можете просто развернуться и уйти из боя. Чтобы отступить, нужно создать «Окно Возможности»: дезориентировать врага, создать физическое препятствие, провести сокрушительную атаку или использовать превосходство в мобильности. Побег без создания "Окна" дает противнику право на атаку по беззащитной цели.
        `
      }
    },
    {
      id: 'economy',
      title: 'Экономика',
      icon: <Icon24Fire />,
      color: '#4CAF50',
      category: 'Экономика и торговля',
      priority: 1,
      content: {
        title: 'Кредиты и Аураномика',
        description: 'Двухуровневая экономическая система: стандартная и экономика Проводников.',
        keyPoints: [
          'Кредиты (₭) - универсальная валюта',
          'Награды за квесты: F-ранг = 100,000₭, S-ранг = 5,000,000,000₭',
          'Награды за Врата: F-ранг = 500,000₭, S-ранг = 50,000,000,000₭',
          'Аураномика: торговля Синки, Контрактами, услугами Проводников',
          'Рынок Синки: Осколки, Эхо, Фокусы'
        ],
        detailedContent: `
### Награды за Квесты и Врата

| Ранг | Награда за Квест | Награда за Врата |
|------|------------------|------------------|
| F    | 100 000 ₭        | 500 000 ₭        |
| E    | 500 000 ₭        | 2 500 000 ₭      |
| D    | 2 500 000 ₭      | 15 000 000 ₭     |
| C    | 50 000 000 ₭     | 250 000 000 ₭    |
| B    | 250 000 000 ₭    | 1 000 000 000 ₭  |
| A    | 1 000 000 000 ₭  | 10 000 000 000 ₭ |
| S    | 5 000 000 000 ₭  | 50 000 000 000 ₭ |
| SS   | -                | -                |
| SSS  | -                | -                |

*Награда может варьироваться от различных факторов, вроде продолжительности мероприятия или его сложности по отношению к Персонажам.*

### Базовые Расходы (за месяц):
- Аренда жилой капсулы в рабочем секторе Неон-Сити: ~70 000 ₭
- Аренда скромной квартиры на Соре: ~200 000 ₭
- Коммунальные платежи, связь, базовый пакет данных от Sber: ~30 000 ₭
- Питание (синтетическая еда, уличные автоматы): ~40 000 ₭
- Питание (натуральные продукты, редкие визиты в кафе): от 150 000 ₭

**Итог**: Проводник F-ранга, получив свою долю (например, 125 000 ₭ из 500 000 ₭ за Врата) или выполнив личный квест, едва покрывает базовые расходы на выживание.

### Расходы Проводника:
- Стандартный пистолет (легальный): от 250 000 ₭
- Качественный бронежилет: от 1 000 000 ₭
- Боеприпасы (одна обойма): 1 500 - 5 000 ₭
- Медицинские услуги (залатать раны после боя): от 100 000 ₭
- Покупка простого Осколка F-ранга: от 50 000 ₭

### Рынок Синки: Цены

| Ранг | Осколок (Средняя цена) | Эхо (Средняя цена) | Фокус (Средняя цена) |
|------|------------------------|-------------------|----------------------|
| F    | 50 000 ₭               | Не существует     | Не существует        |
| E    | 400 000 ₭              | Не существует     | Не существует        |
| D    | 2 000 000 ₭            | 50 000 000 ₭      | Не существует        |
| C    | 40 000 000 ₭           | 100 000 000 ₭     | 500 000 000 ₭        |
| B    | 120 000 000 ₭          | 500 000 000 ₭     | 3 000 000 000 ₭      |
| A    | 800 000 000 ₭          | 2 500 000 000 ₭   | 5 000 000 000 ₭      |
| S    | Фракционная/Национальная реликвия. Не продаётся. | 15 000 000 000 ₭ | 10 000 000 000 ₭ |
| SS   | Слишком редкие, чтобы оценить. | 50 000 000 000 ₭ | Уникальны. Можно получить только от Существа. |
| SSS  | Слишком редкие, чтобы оценить. | 1 000 000 000 000 ₭ | Уникальны. Можно получить только от Существа. |

### Аураномика

Появление Ауры создало совершенно новый, теневой сектор экономики, который эксперты Sber называют "Аураномикой". Он включает в себя торговлю всем, что связано со сверхъестественным.

**Рынок Синки**: Самый крупный и важный сектор. Осколки F-D ранга — ходовой товар на рынках Ичи и чёрных рынках Куро. Фокусы изготавливаются на заказ редкими Ремесленниками и стоят целое состояние. Эхо — это лоты для закрытых аукционов, их цена может достигать десятков миллиардов кредитов.

**Рынок Контрактов**: Самый опасный и нелегальный бизнес. Это не торговля самими Контрактами, а информацией. "Брокеры" продают данные о местонахождении ещё не "занятых" Существ, о ритуалах для их призыва или, что ещё опаснее, о слабостях Проводников и условиях расторжения их Контрактов.

**Рынок Услуг**: Уникальные способности Проводников породили уникальные услуги. Целители могут регенерировать конечности за баснословные деньги. Проводники с даром предвидения работают аналитиками на бирже.
        `
      }
    },
    {
      id: 'islands_detailed',
      title: 'Острова (Детально)',
      icon: <Icon24Info />,
      color: '#00BCD4',
      category: 'Политика и власть',
      priority: 3,
      content: {
        title: 'Шесть Островов-Государств',
        description: 'Центр нового миропорядка после падения старых наций.',
        keyPoints: [
          'Кага: Глобальная столица, воплощение прогресса и порядка',
          'Хоши: Духовный центр, доминирует Отражённый Свет Солнца',
          'Ичи: Воплощение неудержимого капитализма',
          'Куро: Контролируется Чёрной Лилией',
          'Мидзу: Первозданный мир, управляется Советом Кланов',
          'Сора: Дипломатическая столица, нейтральная территория'
        ],
        detailedContent: `
### Кага
**Площадь**: ~50 000 кв. км  
**Население**: ~135 000 000 человек  
**Доминирующая фракция**: Порядок (официально), Arasaka и Sber (фактически)

#### Общая атмосфера
Кага — это глобальная столица, воплощение прогресса и порядка. На первый взгляд, это идеальный мегаполис. Улицы безупречно чисты благодаря армиям роботов-уборщиков, воздух прозрачен даже в промышленных зонах за счет новейших систем фильтрации, а по городу курсирует бесшумный и всегда точный общественный транспорт на магнитной подушке.

#### Районы Каги
- **Эвербрайт**: Район власти, где каждый камень дышит строгостью и официальным статусом
- **Зелёный Плац**: Самый дорогой и закрытый район в мире
- **Неон-Сити**: Сердце Каги, гигантский человеческий улей, где жизнь кипит 24/7
- **Фронтир**: Промышленное сердце Каги

#### Столпы Власти
- **Порядок**: Официальная власть. Они создают законы, патрулируют улицы и поддерживают фасад стабильности
- **Sber**: Цифровой гигант. Они контролируют почти всю информацию, финансы и логистику
- **Arasaka**: Промышленный и военный гигант. Они производят оружие, роботов и импланты

### Хоши
**Площадь**: ~120 000 кв. км  
**Население**: ~40 000 000 человек  
**Доминирующая фракция**: Отражённый Свет Солнца

#### Общая атмосфера
Если Кага — это симфония стали и неона, то Хоши — это тихая мелодия, исполняемая ветром в бамбуковых рощах и звоном ритуальных колокольчиков. Это остров, где время течёт иначе. Здесь не гонятся за прогрессом ради прогресса. Технологии служат гармонии и традиции.

#### Районы Хоши
- **Амара**: Духовный и административный центр Хоши и всей фракции Отражённый Свет Солнца
- **Обитель Тихого Ветра**: Сеть уединенных монастырей, главная академия для элитных воинов фракции
- **Предгорье Лотоса**: Оживленный и шумный город у подножия гор
- **Заповедник Муши**: Обширная и почти нетронутая лесная зона
- **Долина Хэйан**: Особая, изолированная долина, где ткань реальности аномально тонка

### Ичи
**Площадь**: ~25 000 кв. км  
**Население**: ~80 000 000 человек  
**Доминирующая фракция**: Де-юре отсутствует, де-факто — Торговая Гильдия и Чёрная Лилия

#### Общая атмосфера
Ичи — это воплощение неудержимого капитализма. Это остров, который никогда не спит, вечно гудящий улей, где воздух пропитан смесью запахов: морской соли из порта, экзотических специй с Гранд-Базара, дорогих духов из бутиков и озона от бесчисленных неоновых вывесок.

#### Районы Ичи
- **Золотой Берег**: Финансовое сердце не только острова, но и всего мира
- **Гранд-Базар Аурон**: Гигантский, многоуровневый рынок, раскинувшийся на несколько десятков квадратных километров
- **Порт-де-Люн**: Главный портовый район, вечно окутанный туманом и запахом рыбы
- **Район Развлечений "Камуро"**: Квартал, где Ичи тратит заработанные деньги

### Куро
**Площадь**: ~35 000 кв. км  
**Население**: ~55 000 000 человек  
**Доминирующая фракция**: Чёрная Лилия

#### Общая атмосфера
Над Куро почти всегда висит серое, свинцовое небо, из которого моросит мелкий, пахнущий кислотой, дождь. Солнце здесь — редкий гость, его свет с трудом пробивается сквозь плотный смог от работающих на износ старых заводов.

#### Районы Куро
- **Район Падающих Звёзд**: Неофициальная столица острова и нервный центр империи Чёрной Лилии
- **Ржавый Пояс**: Огромная территория, усеянная остовами заброшенных заводов
- **Порт "Могила"**: Мрачный и грязный портовый район, откуда на другие острова уходят контрабандные грузы
- **Тёмный Континент**: Аномальная территория на севере Куро, возникшая после битвы двух Проводников SSS-ранга

### Мидзу
**Площадь**: ~70 000 кв. км  
**Население**: ~15 000 000 человек  
**Доминирующая фракция**: Отсутствует; управляется Советом Кланов

#### Общая атмосфера
Мидзу — это первозданный мир, почти не тронутый рукой цивилизации. Это остров гигантских, поросших мхом деревьев, чьи кроны скрывают небо; туманных долин, где эхом разносится рёв неизвестных зверей; и кристально чистых рек, прорезающих скалы.

#### Социальная структура
- **Деревня Сокрытого Тумана**: Крупнейшее и самое открытое для чужаков поселение
- **Сердце Леса**: Глубочайшая и самая древняя часть острова, куда запрещён вход для всех, кроме избранных шаманов
- **Горы Каменного Кулака**: Суровый горный хребет, отделяющий побережье от внутренних земель

### Сора
**Площадь**: ~30 000 кв. км  
**Население**: ~30 000 000 человек  
**Статус**: Порядок официально

#### Общая атмосфера
Сора — это островок здравомыслия в безумном мире. Это дипломатическая столица, где встречаются представители всех фракций и решаются судьбы мира не силой оружия, а словом и интригой.

#### Районы Соры
- **Район Равновесия**: Административный и дипломатический центр
- **Старый Город**: Историческое сердце Соры с узкими мощёными улочками
- **Рыночный Квартал**: Торговое сердце острова
        `
      }
    }
  ];

  const filteredSections = sections.filter(section =>
    section.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
    section.content.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
    section.content.description.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // Группируем разделы по категориям и сортируем по приоритету
  const groupedSections = filteredSections.reduce((groups, section) => {
    const category = section.category || 'Другое';
    if (!groups[category]) {
      groups[category] = [];
    }
    groups[category].push(section);
    return groups;
  }, {} as Record<string, typeof sections>);

  // Сортируем разделы внутри каждой категории по приоритету
  Object.keys(groupedSections).forEach(category => {
    groupedSections[category].sort((a, b) => (a.priority || 999) - (b.priority || 999));
  });

  // Порядок категорий
  const categoryOrder = [
    'Основы мира',
    'Политика и власть', 
    'Боевая система',
    'Экономика и торговля',
    'Другое'
  ];

  const renderMarkdownContent = (content: string) => {
    const lines = content.split('\n');
    const elements: JSX.Element[] = [];
    let key = 0;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      
      if (line.startsWith('### ')) {
        elements.push(
          <Header key={key++} style={{ marginTop: '16px', marginBottom: '8px', fontSize: '18px' }}>
            {line.substring(4)}
          </Header>
        );
      } else if (line.startsWith('#### ')) {
        elements.push(
          <Header key={key++} style={{ marginTop: '12px', marginBottom: '6px', fontSize: '16px' }}>
            {line.substring(5)}
          </Header>
        );
      } else if (line.startsWith('**') && line.endsWith('**')) {
        elements.push(
          <Text key={key++} style={{ fontWeight: 'bold', marginBottom: '8px' }}>
            {line.substring(2, line.length - 2)}
          </Text>
        );
      } else if (line.startsWith('- ')) {
        elements.push(
          <div key={key++} style={{ marginLeft: '16px', marginBottom: '4px' }}>
            <Text>• {line.substring(2)}</Text>
          </div>
        );
      } else if (line.startsWith('| ')) {
        // Таблица - пропускаем заголовок таблицы
        if (line.includes('---')) continue;
        
        const cells = line.split('|').filter(cell => cell.trim());
        if (cells.length > 1) {
          elements.push(
            <div key={key++} style={{ 
              display: 'flex', 
              marginBottom: '4px', 
              padding: '8px',
              backgroundColor: 'var(--vkui--color_background_secondary)',
              borderRadius: '4px'
            }}>
              {cells.map((cell, cellIndex) => (
                <div key={cellIndex} style={{ 
                  flex: 1, 
                  padding: '0 8px',
                  borderRight: cellIndex < cells.length - 1 ? '1px solid var(--vkui--color_field_border)' : 'none'
                }}>
                  <Text style={{ fontSize: '14px' }}>{cell.trim()}</Text>
                </div>
              ))}
            </div>
          );
        }
      } else if (line.startsWith('*') && line.endsWith('*')) {
        elements.push(
          <Text key={key++} style={{ 
            fontStyle: 'italic', 
            marginBottom: '8px',
            color: 'var(--vkui--color_text_secondary)'
          }}>
            {line.substring(1, line.length - 1)}
          </Text>
        );
      } else if (line.length > 0) {
        elements.push(
          <Text key={key++} style={{ marginBottom: '8px', lineHeight: '1.5' }}>
            {line}
          </Text>
        );
      } else {
        elements.push(<div key={key++} style={{ height: '8px' }} />);
      }
    }

    return elements;
  };

  const renderSectionContent = (section: typeof sections[0]) => (
    <Card key={section.id} style={{ marginBottom: '16px' }}>
      <div style={{ padding: '16px' }}>
        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '12px' }}>
          <div style={{ 
            color: section.color, 
            marginRight: '12px',
            fontSize: '24px'
          }}>
            {section.icon}
          </div>
          <div>
            <Header style={{ color: section.color, margin: 0 }}>
              {section.content.title}
            </Header>
          </div>
        </div>
        
        <Text style={{ marginBottom: '16px', lineHeight: '1.5' }}>
          {section.content.description}
        </Text>
        
        <div>
          <Header style={{ marginBottom: '8px' }}>
            Ключевые моменты:
          </Header>
          <ul style={{ margin: 0, paddingLeft: '20px' }}>
            {section.content.keyPoints.map((point, index) => (
              <li key={index} style={{ marginBottom: '8px', lineHeight: '1.4' }}>
                <Text>{point}</Text>
              </li>
            ))}
          </ul>
        </div>

        {section.content.detailedContent && (
          <div style={{ marginTop: '20px' }}>
            <Header style={{ marginBottom: '12px' }}>
              Подробная информация:
            </Header>
            <div style={{ 
              backgroundColor: 'var(--vkui--color_background_secondary)', 
              padding: '16px', 
              borderRadius: '8px',
              border: `1px solid ${section.color}20`
            }}>
              {renderMarkdownContent(section.content.detailedContent)}
            </div>
          </div>
        )}
      </div>
    </Card>
  );

  return (
    <Panel id={id}>
      <PanelHeader before={<PanelHeaderBack onClick={() => routeNavigator.push('/')} />}>
        Справочник
      </PanelHeader>
      
      <Group>
        <div style={{ padding: '16px' }}>
          <Search
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Поиск по справочнику..."
            style={{ marginBottom: '16px' }}
          />
          
          {searchQuery && (
            <div style={{ marginBottom: '16px', padding: '12px', backgroundColor: 'var(--vkui--color_background_secondary)', borderRadius: '8px' }}>
              <Text>Найдено разделов: {filteredSections.length}</Text>
            </div>
          )}
          
          {selectedSection ? (
            <div>
              <div style={{ marginBottom: '16px' }}>
                <Button
                  mode="tertiary"
                  onClick={() => setSelectedSection(null)}
                  before={<Icon24ChevronRight style={{ transform: 'rotate(180deg)' }} />}
                >
                  Назад к разделам
                </Button>
              </div>
              {renderSectionContent(sections.find(s => s.id === selectedSection)!)}
            </div>
          ) : (
            <div>
              {categoryOrder.map(category => {
                const categorySections = groupedSections[category];
                if (!categorySections || categorySections.length === 0) return null;

                return (
                  <div key={category} style={{ marginBottom: '32px' }}>
                    <Header style={{ 
                      marginBottom: '16px', 
                      padding: '8px 16px',
                      backgroundColor: 'var(--vkui--color_background_secondary)',
                      borderRadius: '8px',
                      border: '1px solid var(--vkui--color_field_border)'
                    }}>
                      {category}
                    </Header>
                    <CardGrid size="s">
                      {categorySections.map((section) => (
                        <Card
                          key={section.id}
                          style={{ 
                            cursor: 'pointer',
                            transition: 'transform 0.2s, box-shadow 0.2s',
                            border: `2px solid ${section.color}20`,
                            height: '180px',
                            display: 'flex',
                            flexDirection: 'column'
                          }}
                          onClick={() => setSelectedSection(section.id)}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.transform = 'translateY(-2px)';
                            e.currentTarget.style.boxShadow = `0 4px 12px ${section.color}30`;
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.transform = 'translateY(0)';
                            e.currentTarget.style.boxShadow = 'none';
                          }}
                        >
                          <div style={{ 
                            padding: '16px', 
                            textAlign: 'center',
                            height: '100%',
                            display: 'flex',
                            flexDirection: 'column',
                            justifyContent: 'space-between'
                          }}>
                            <div>
                              <div style={{ 
                                color: section.color, 
                                fontSize: '32px',
                                marginBottom: '12px'
                              }}>
                                {section.icon}
                              </div>
                              <Header style={{ color: section.color, margin: 0, fontSize: '16px' }}>
                                {section.title}
                              </Header>
                            </div>
                            <Text style={{ 
                              marginTop: '8px', 
                              fontSize: '13px', 
                              opacity: 0.8,
                              lineHeight: '1.3',
                              overflow: 'hidden',
                              display: '-webkit-box',
                              WebkitLineClamp: 3,
                              WebkitBoxOrient: 'vertical'
                            }}>
                              {section.content.description.substring(0, 120)}...
                            </Text>
                          </div>
                        </Card>
                      ))}
                    </CardGrid>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </Group>
    </Panel>
  );
};
